<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Admins</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/shared.css">

  <style>
/* ===== Admin Dashboard Theme (copied) ===== */
* {
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}
body {
  background: #F5F7FB;
  margin: 0;
  color: #222;
}
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 240px;
  background: #1F1F2E;
  color: #fff;
  padding: 20px;
}
.sidebar h2 { margin-bottom: 30px; font-weight: 600; }
.sidebar ul { list-style: none; padding: 0; }
.sidebar ul li { margin-bottom: 15px; }
.sidebar ul li a { text-decoration: none; color: #CFCFE8; display: block; padding: 10px 12px; border-radius: 8px; transition: 0.3s; }
.sidebar ul li a:hover, .sidebar ul li a.active { background: linear-gradient(90deg, #6C63FF, #8E7CFF); color: #fff; }
.main { flex: 1; padding: 30px; }
.topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
.topbar h1 { font-size:22px; font-weight:600; }
.profile { background:#fff; padding:8px 15px; border-radius:30px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.content-box { background:#fff; padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
.card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
/* ===== end admin theme ===== */
  </style>

  <style>
/* Page Structure */
.content-wrapper {
  display: flex;
  flex-direction: column;
  gap: 25px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.page-header h2 {
  font-size: 22px;
  font-weight: 600;
}

/* Buttons */
.primary-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(90deg, #6C63FF, #8E7CFF);
  color: white;
  cursor: pointer;
  font-weight: 500;
  transition: 0.3s;
}

.primary-btn:hover {
  opacity: 0.9;
}

.secondary-btn {
  padding: 10px 18px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
}

/* Form Card */
.form-card {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}

.form-card h3 {
  margin-bottom: 20px;
  font-weight: 600;
}

/* Grid Layout */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
}

/* Form Elements */
.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 6px;
  font-size: 13px;
  color: #555;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ddd;
  outline: none;
  transition: 0.3s;
  color: #000;
}

.form-group input:focus,
.form-group select:focus {
  border-color: #6C63FF;
  box-shadow: 0 0 0 2px rgba(108,99,255,0.15);
}

/* Admin list controls */
.admin-active-select {
  min-width: 110px;
  padding: 8px 10px;
  background: #fff;
  color: #111;
  border: 1px solid #ddd;
  border-radius: 6px;
}
.admin-delete-btn {
  padding: 6px 10px;
  border-radius: 6px;
  background: #fff;
  border: 1px solid #e74c3c;
  color: #e74c3c;
  cursor: pointer;
}

.admin-delete-btn:disabled { opacity: 0.6; cursor: default; }

/* Actions */
.form-actions {
  margin-top: 25px;
  display: flex;
  gap: 15px;
}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h2>RentProx</h2>
    <ul>
      <li><a href="admin_dashboard.html">Dashboard</a></li>
      <li><a href="manage_admins.html" class="active">Manage Admins</a></li>
      <li><a href="#">Manage Users</a></li>
      <li><a href="#">Requests</a></li>
      <li><a href="#">Listings</a></li>
      <li><a href="admin_login.html">Logout</a></li>
    </ul>
  </aside>

  <div class="main">
    <div class="topbar">
      <h1>Manage Admins</h1>
      <div class="profile">Admin</div>
    </div>

    <div class="content-box">
      <!-- Add Admin Form Card -->
      <div class="form-card">

        <h3>Create New Admin</h3>

        <div class="form-grid">

          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="adminName" placeholder="Enter admin name">
          </div>

          <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="adminEmail" placeholder="Enter email">
          </div>

          <div class="form-group">
            <label>Password</label>
            <input type="password" id="adminPassword" placeholder="Enter password">
          </div>



        </div>

        <div class="form-actions">
          <button class="primary-btn" id="createAdminBtn">Create Admin</button>
        </div>

      </div>

      <!-- Admins List -->
      <div class="content-box" id="adminsList">
        Loading admins...
      </div>
    </div>
  </div>
</div>

<script>
// Accept token from URL and store in localStorage (so navigation via query works)
(function(){
  const urlParams = new URLSearchParams(window.location.search);
  const urlToken = urlParams.get('token');
  if (urlToken) {
    localStorage.setItem('token', urlToken);
    // remove token from URL without reloading
    const newUrl = window.location.origin + window.location.pathname;
    history.replaceState({}, '', newUrl);
  }

  // Intercept clicks to protected HTML pages so token is sent via query param
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a');
    if (!a) return;
    const href = a.getAttribute('href');
    const protectedPaths = ['admin_dashboard.html', 'manage_admins.html'];
    if (href && protectedPaths.includes(href)) {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'admin_login.html';
      const sep = href.includes('?') ? '&' : '?';
      window.location.href = href + sep + 'token=' + encodeURIComponent(token);
    }
  });

  // get token from storage (after possibly copying from URL)
  const token = localStorage.getItem('token');
  if (!token) { window.location.href = 'admin_login.html'; return; }

  // API base (ensure requests go to backend)
  const API_BASE = 'http://localhost:3000';

  // Wire Create Admin button immediately so it works even if admin list is empty
  const createBtn = document.getElementById('createAdminBtn');
  if (createBtn) {
    createBtn.addEventListener('click', async function(){
      const name = document.getElementById('adminName').value.trim();
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;

      if (!name || !email || !password) return alert('Fill all fields');

      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';
      try {
        const url = API_BASE + '/api/admins';
        console.log('Creating admin ->', { url, token, name, email });
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ name, email, password })
        });

        // If server returned non-JSON (like HTML error page), show it
        const ct = resp.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await resp.text();
          console.error('Non-JSON response from server', resp.status, text);
          if (resp.status === 401) { localStorage.removeItem('token'); window.location.href='admin_login.html'; return; }
          alert('Server error: ' + (text || resp.status));
          return;
        }

        if (resp.status === 401) { localStorage.removeItem('token'); window.location.href='admin_login.html'; return; }
        const jr = await resp.json();
        if (!jr.success) return alert(jr.message || 'Create failed');
        alert('Admin created');
        window.location.reload();
      } catch (err) {
        console.error('Create admin error', err);
        alert('Network or server error creating admin - see console');
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = 'Create Admin';
      }
    });
  }

  // Fetch and render admins list (separate from wiring create button)
  (async function loadAdmins(){
    try {
      const res = await fetch(API_BASE + '/api/admins', { headers: { 'Authorization': 'Bearer ' + token } });
      if (res.status === 401) { localStorage.removeItem('token'); window.location.href = 'admin_login.html'; return; }
      if (!res.ok) { document.getElementById('adminsList').innerText = 'Failed to load admins'; return; }
      const data = await res.json();
      if (!data.success) { document.getElementById('adminsList').innerText = data.message || 'No admins'; return; }
      const list = data.admins || [];
      const container = document.getElementById('adminsList');
      container.innerHTML = '';
      if (list.length === 0) { container.innerText = 'No admins found.'; return; }

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th style="text-align:left; padding:8px;">ID</th><th style="text-align:left; padding:8px;">Name</th><th style="text-align:left; padding:8px;">Email</th><th style="text-align:left; padding:8px;">Actions</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      list.forEach(a => {
        const tr = document.createElement('tr');
        const deleteBtn = `<button class="secondary-btn admin-delete-btn" data-id="${a.id}" style="margin-left:8px;">Delete</button>`;
        tr.innerHTML = `<td style="padding:8px; border-top:1px solid #eee">${a.id}</td><td style="padding:8px; border-top:1px solid #eee">${a.name || ''}</td><td style="padding:8px; border-top:1px solid #eee">${a.email}</td><td style="padding:8px; border-top:1px solid #eee">${deleteBtn}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);



      container.addEventListener('click', async function(e){
        const btn = e.target.closest('.admin-delete-btn');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!confirm('Delete this admin?')) return;
        btn.disabled = true;
        try {
          const r = await fetch(API_BASE + '/api/admins/' + encodeURIComponent(id), {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (!r.ok) {
            const txt = await r.text();
            console.error('Delete admin failed', r.status, txt);
            alert('Failed to delete admin');
            btn.disabled = false;
            return;
          }
          // remove the row from UI
          const row = btn.closest('tr');
          if (row) row.remove();
        } catch (err) {
          console.error('Delete admin error', err);
          alert('Network error deleting admin');
          btn.disabled = false;
        }
      });

    } catch (err) {
      console.error(err);
      document.getElementById('adminsList').innerText = 'Error loading admins';
    }
  })();

})();
</script>

</body>
</html>